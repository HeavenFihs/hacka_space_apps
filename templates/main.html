<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QUAVI - Celestial Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main_style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js"></script>
</head>
<body class="main">
    <header class="top-bar">
        <div class="left">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="QUAVI Logo" class="nav-logo">
        </div>
        <div class="right">
            <button class="doc-btn">Documentation</button>
            <div class="translate">
                <img src="{{ url_for('static', filename='images/gtranslate.png') }}" alt="Translate" class="translate-icon">
                <div class="dropdown hidden">
                    <div>
                        <button class="doc-btn drp-btn">
                            <a href="#" onclick="setLang('en'); return false;" class="btn right">
                                <img src="{{ url_for('static', filename='images/gb_flag.png') }}" class="flag"> English
                            </a>
                        </button>
                    </div>
                    <div>
                        <button class="doc-btn drp-btn">
                            <a href="#" onclick="setLang('es'); return false;" class="btn right">
                                <img src="{{ url_for('static', filename='images/sp_flag.png') }}" class="flag"> Español
                            </a>
                        </button>
                    </div>
                    <div>
                        <button class="doc-btn drp-btn">
                            <a href="#" onclick="setLang('zh-CN'); return false;" class="btn right">
                                <img src="{{ url_for('static', filename='images/ch_flag.png') }}" class="flag"> 中文
                            </a>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <section class="main-content">
        <h1>Upload Your Celestial Data</h1>

        <div class="upload-container">
            <div id="drop-area">
                <p><strong>Drag & Drop Files Here</strong></p>
                <p>Supported format: CSV</p>
                <input type="file" id="fileInput" accept=".csv" hidden>
                <button id="browseBtn">Browse Files</button>
            </div>

            <div class="data-preview">
                <h3>Data Preview</h3>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Star ID</th>
                            <th>Transit Depth (PPM)</th>
                            <th>Orbital Period (Days)</th>
                            <th>Stellar Radius (Solar radii)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="mode-buttons">
            <button id="explorerBtn" class="disabled">Explorer Mode</button>
            <button id="investigatorBtn" class="disabled">Investigator Mode</button>
        </div>
    </section>

    <footer>
        <p>©2025 Quavi. All rights reserved.</p>
    </footer>

    <script>
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const tableBody = document.querySelector('#dataTable tbody');
        const explorerBtn = document.getElementById('explorerBtn');
        const investigatorBtn = document.getElementById('investigatorBtn');

        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFiles);

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('hover');
        });
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('hover'));
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('hover');
            handleFiles({ target: { files: e.dataTransfer.files } });
        });

        function handleFiles(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload_csv', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // Clear previous data
                    tableBody.innerHTML = '';

                    // Fill with new data, up to 4 rows
                    const rowsToShow = data.data.slice(0, 4);
                    rowsToShow.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><input type="radio" name="recordSelect" value="${index}"></td>
                            <td>${row['kepid'] || ''}</td>
                            <td>${row['koi_depth'] || ''}</td>
                            <td>${row['koi_period'] || ''}</td>
                            <td>${row['koi_srad'] || ''}</td>
                        `;
                        tableBody.appendChild(tr);
                    });

                    if (data.data.length > 0) {
                        explorerBtn.classList.remove('disabled');
                        investigatorBtn.classList.remove('disabled');
                    }
                })
                .catch(err => alert('Upload failed: ' + err));
        }

        // Explorer Mode: ensure record is selected
        explorerBtn.addEventListener('click', () => {
            const selected = document.querySelector('input[name="recordSelect"]:checked');
            if (!selected) {
                alert("Please select a record first.");
                return;
            }
            const recordIndex = selected.value;
            window.location.href = "/explorer?record=" + recordIndex;
        });

        // Investigator Mode: ensure record is selected
        investigatorBtn.addEventListener('click', () => {
            const selected = document.querySelector('input[name="recordSelect"]:checked');
            if (!selected) {
                alert("Please select a record first.");
                return;
            }
            const recordIndex = selected.value;
            window.location.href = "/investigator?record=" + recordIndex;
        });

    </script>
    <script src="{{ url_for('static', filename='js/translate.js') }}"></script>
</body>
</html>
